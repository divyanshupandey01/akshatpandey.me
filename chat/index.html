<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Global Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* --- DARK THEME CHAT CSS (FIXED FOR MOBILE) --- */
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
  
  body {
    background-color: #000;
    color: #fff;
    /* 100dvh solves the address bar issue on phones */
    height: 100dvh; 
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Header */
  header {
    flex-shrink: 0; /* Prevents header from shrinking */
    padding: 15px;
    background: rgba(20, 20, 20, 0.95);
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
  }
  
  header h2 { font-size: 1.1rem; color: #fff; }
  header .status { font-size: 0.8rem; color: #00ffcc; display: flex; align-items: center; gap: 6px; }
  header .dot { width: 8px; height: 8px; background: #00ffcc; border-radius: 50%; box-shadow: 0 0 8px #00ffcc; }
  .back-btn { text-decoration: none; color: #888; font-size: 0.9rem; }

  /* Chat Area */
  #chat-feed {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    /* Extra padding at bottom so messages aren't hidden behind input bar */
    padding-bottom: 100px; 
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  /* Message Bubbles */
  .msg-row { display: flex; align-items: flex-end; gap: 10px; max-width: 100%; }
  .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #333; flex-shrink: 0; }

  .bubble {
    padding: 10px 16px;
    border-radius: 18px;
    font-size: 0.95rem;
    line-height: 1.4;
    position: relative;
    max-width: 75vw;
    word-wrap: break-word;
  }
  
  .bubble .name { font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-bottom: 4px; display: block; }

  /* Theirs */
  .msg-row.theirs .bubble { background: #1a1a1a; border-bottom-left-radius: 4px; color: #eee; }
  
  /* Mine */
  .msg-row.mine { flex-direction: row-reverse; }
  .msg-row.mine .bubble { background: #00ffcc; color: #000; border-bottom-right-radius: 4px; }
  .msg-row.mine .name, .msg-row.mine .avatar { display: none; }

  /* Input Area - FIXED POSITION TO STAY ON SCREEN */
  #input-area {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #111;
    border-top: 1px solid #222;
    padding: 15px;
    display: flex;
    gap: 10px;
    z-index: 9999;
    /* Handles iPhone notch/home bar area */
    padding-bottom: max(15px, env(safe-area-inset-bottom));
  }
  
  input {
    flex: 1;
    background: #222;
    border: none;
    padding: 12px 18px;
    border-radius: 99px;
    color: #fff;
    font-size: 16px; /* Prevents iOS zoom */
    outline: none;
  }
  
  input:focus { border: 1px solid #00ffcc; }
  
  button {
    background: #00ffcc;
    color: #000;
    border: none;
    width: 46px;
    height: 46px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
  }

  button:active { transform: scale(0.95); }
</style>
</head>
<body>

  <header>
    <a href="index.html" class="back-btn">← Home</a>
    <h2>Global Chat</h2>
    <div class="status"><div class="dot"></div> Live</div>
  </header>

  <div id="chat-feed">
    <div style="text-align:center;color:#444;margin-top:50px;font-size:0.9rem;">Connecting...</div>
  </div>

  <form id="input-area" onsubmit="sendMessage(event)">
    <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off">
    <button type="submit">➤</button>
  </form>

  <script type="module">
    /* --- FIREBASE CONFIG (MATCHING YOUR MAIN PAGE) --- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot,
      serverTimestamp, limit, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig={
      apiKey:"AIzaSyCY88mD-sHqxZiOGkQZbliTXG1QmySPesI",
      authDomain:"akshat-comments.firebaseapp.com",
      projectId:"akshat-comments"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* --- USER IDENTIFICATION --- */
    // Default to Guest
    let currentUser = {
      uid: "anon_" + Math.random().toString(36).substr(2, 5),
      name: "Anonymous",
      photo: "https://cdn-icons-png.flaticon.com/512/847/847969.png",
      role: "guest"
    };

    // Try to sync with main page login
    async function loadUser() {
      const storedUid = localStorage.getItem("akshat_uid");
      if (storedUid) {
        try {
          const userDoc = await getDoc(doc(db, "users", storedUid));
          if (userDoc.exists()) {
            currentUser = { ...userDoc.data(), uid: storedUid };
          }
        } catch (e) { console.error("Login sync failed", e); }
      }
    }
    
    /* --- CHAT LOGIC --- */
    const feed = document.getElementById("chat-feed");
    const msgInput = document.getElementById("msgInput");

    // 1. Send Message
    window.sendMessage = async (e) => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text) return;

      msgInput.value = ""; 

      try {
        await addDoc(collection(db, "global_chat"), {
          text: text,
          uid: currentUser.uid,
          name: currentUser.name,
          photo: currentUser.photo,
          role: currentUser.role || "user",
          createdAt: serverTimestamp()
        });
        scrollToBottom();
      } catch (err) {
        console.error(err);
        alert("Error sending. Check connection.");
      }
    };

    // 2. Receive Messages
    const q = query(collection(db, "global_chat"), orderBy("createdAt", "asc"), limit(50));
    let firstLoad = true;

    onSnapshot(q, (snapshot) => {
      feed.innerHTML = ""; 
      
      if(snapshot.empty) {
        feed.innerHTML = `<div style="text-align:center;color:#444;margin-top:20px">No messages yet.</div>`;
        return;
      }

      snapshot.forEach((doc) => {
        const msg = doc.data();
        const isMine = msg.uid === currentUser.uid;
        
        const nameDisplay = msg.role === "admin" 
          ? `<span style="color:#ff4444">★ ${msg.name}</span>` 
          : msg.name;

        const div = document.createElement("div");
        div.className = `msg-row ${isMine ? "mine" : "theirs"}`;
        
        div.innerHTML = `
          <img src="${msg.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="avatar">
          <div class="bubble">
            ${isMine ? "" : `<span class="name">${nameDisplay}</span>`}
            ${escapeHtml(msg.text)}
          </div>
        `;
        feed.appendChild(div);
      });

      if (firstLoad) {
        setTimeout(scrollToBottom, 100);
        firstLoad = false;
      } else {
        // Auto scroll if near bottom
        if (feed.scrollHeight - feed.scrollTop - feed.clientHeight < 300) {
          scrollToBottom();
        }
      }
    });

    function scrollToBottom() {
      feed.scrollTop = feed.scrollHeight;
    }

    function escapeHtml(text) {
      if(!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // Initialize
    loadUser();

  </script>
</body>
</html>
